# Docker Compose configuration for CorkStay Property Lettings Application
# This sets up a multi-container environment with web app and database

services:
  # Web Application Service
  app:
    # Option 1: Build from local Dockerfile (may not work with snap docker)
    # build: .                                   # Build from Dockerfile in current directory
    # Option 2: Use pre-built image from registry (recommended for snap docker)
    build: .
    container_name: corkstay-web               # Custom container name for easier management
    environment:
      - APP_ENV=production                     # Set application environment to production
    # Configure DNS servers to fix resolution issues with snap docker
    dns:
      - 8.8.8.8                                # Google DNS primary
      - 8.8.4.4                                # Google DNS secondary
      - 1.1.1.1                                # Cloudflare DNS
    volumes:
      # Mount properties directory for persistent image storage
      - ./properties:/var/www/html/swd-corkstay/properties
    depends_on:
      - corkstay-db                            # Ensure database starts before web app
    networks:
      - corkstay-network                       # Connect to custom network
  # Database Service
  db:
    image: mysql:8.0                           # Use official MySQL 8.0 image
    container_name: corkstay-mysql             # Custom container name for easier management
    environment:
      # MySQL configuration - CHANGE THESE PASSWORDS IN PRODUCTION!
      - MYSQL_ROOT_PASSWORD=rootpassword      # Root password for MySQL
      - MYSQL_DATABASE=corkstay               # Create database named 'corkstay'
      - MYSQL_USER=corkstay_user              # Create application user
      - MYSQL_PASSWORD=corkstay_password      # Password for application user
    volumes:
      # Persistent storage for database data
      - mysql_data:/var/lib/mysql
      # Initialize database with SQL dump on first run
      - ./corkstay.sql:/docker-entrypoint-initdb.d/corkstay.sql
    networks:
      - corkstay-network                       # Connect to custom network

# Named volumes for persistent data storage
volumes:
  mysql_data:                                  # Persistent volume for MySQL data

# Custom network for container communication
networks:
  corkstay-network:
